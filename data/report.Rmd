---
title: "Conservation Area: `r params$mpas`"
output:
  html_document:
    self_contained: true
    toc: true
    toc_depth: 3
    toc_float: false
  mpas: "Western and Emerald Banks Marine Refuge"
---

## Key Findings

```{r, echo=FALSE, message=FALSE, warning=FALSE}
if(!require(librarian)) install.packages("librarian")
pkgs <- c("sf",
          "targets",
          "viridis",
          "j-harbin/dataSPA",
          "arcpullr",
          "ArgoCanada/argoFloats",
          "casaultb/azmpdata",
          "raster",
          "dfo-mar-odis/TBSpayRates",
          "readxl",
          "ggplot2",
          "shinyBS",
          "Maritimes/Mar.datawrangling",
          "DT",
          "magrittr",
          "RColorBrewer",
          "dplyr",
          "tidyr",
          "stringr",
          "officer",
          "RColorBrewer",
          "car",
          "purrr",
          "dfo-mar-mpas/MarConsNetAnalysis",
          "dfo-mar-mpas/MarConsNetData",
          "dfo-mar-mpas/MarConsNetApp",
          "rnaturalearth",
          "DBI",
          "duckdb",
          "rmarkdown",
          "shiny",
          "measurements",
          "mregions2",
          "patchwork",
          "units",
          "dankelley/oceglider",
          "RCurl",
          "oce",
          "gsw",
          "leaflet",
          "rgbif",
          "qs",
          "qs2",
          "odbc",
          "rvest",
          "webshot2")
shelf(pkgs)

gradeLegendUI <- function(type = "indicator") {
    grades <- grade_description(type)

    tags$div(
      style = "display:flex; gap:15px; flex-wrap:nowrap; align-items:center; margin-top:10px;",
      lapply(names(grades), function(g) {
        tags$div(
          style = "display:flex; align-items:center; gap:5px;",
          tags$div(style = paste0("width:20px; height:20px; background-color:", flowerPalette[g], "; border:1px solid #000;")),
          paste0(g, " — ", grades[[g]])
        )
      })
    )
 }
 

tar_load(c(MPAs,
           pillar_ecol_df,
           Context,
           flowerPalette,
           objective_tabs,
           N_Objectives,
           MPA_report_card,
           collaborations,
           creature_feature,
           cost_of_mpas,
           om,
           regions,
           Ecological,
           all_project_geoms,
           deliverables,
           csas,
           climate_change,
           salary,
           objective_tabs,
           all_indicator_project_geoms), store=path_to_store())

# FIXME (REMOVE)
MPAs$date_of_establishment <- 2017

embed_image <- function(file_path, width = 600) {
    mime <- paste0("image/", tools::file_ext(file_path))
    data_uri <- base64enc::dataURI(file = file_path, mime = mime)
    sprintf('<img src="%s" width="%s"/>\n\n', data_uri, width)
    #sprintf('<img src="%s" width="%s"/>', data_uri, width)

}

pillar_ecol_df2 <- pillar_ecol_df[order(pillar_ecol_df$indicator),]

if (any(pillar_ecol_df2$areaID == "Non_Conservation_Area")) {
pillar_ecol_df2 <- pillar_ecol_df2[-which(pillar_ecol_df2$areaID == "Non_Conservation_Area"),]
}

if (any(pillar_ecol_df2$status_statement == "No features are represented.", na.rm = TRUE)) {
    pillar_ecol_df2$status_statement[pillar_ecol_df2$status_statement == "No features are represented."] <- paste0(
          "No features are represented. ** Note: a score will still be assigned if multiple MPAs are 'tied' for the lowest rank. ",
          "For example, if no features are represented but an MPA has a score of 50, this indicates that 50% of MPAs share the 'least represented' status."
        )
}


image_folder <- file.path(sub("/[^/]*$", "", path_to_store()), "data", "plot")
image_files <- list.files(image_folder, full.names = TRUE)


## PREP FOR KEY FINDINGS


# AREA GRADE
last_year <- paste0((as.numeric(format(Sys.time(), "%Y"))-1),"-", format(Sys.time(), "%Y"))
string <- params$mpas
p <- pillar_ecol_df2[which(pillar_ecol_df2$areaID == params$mpas),]

KEEP <- calc_group_score(df=p,grouping_var = "bin",
                               score_var = "score",
                               weight_var = "weight")
area_grade <- as.character(calc_letter_grade(weighted.mean(x=KEEP$score, w=KEEP$weight, na.rm=TRUE)))

## SUGGESTED FURTHER RESEARCH

summary_table <- data.frame(
  `Indicator Bin` = character(),
  `Grade` = character(),
  `Number of Indicators` = character(),
  stringsAsFactors = FALSE
)

# Loop through bins and calculate grades
for (i in seq_along(unique(p$bin))) {
  keep <- which(p$bin == unique(p$bin)[i])
  df <- p[keep, ]
  
  group_df <- calc_group_score(df=df,grouping_var = "bin",
                               score_var = "score",
                               weight_var = "weight")
  grade <- as.character(calc_letter_grade(weighted.mean(x=group_df$score, w=group_df$weight, na.rm=TRUE)))
  
  if (any(is.na(df$indicator) | df$indicator == "placeholder" | is.na(df$score))) {
    indicatorLength <- length(df$indicator[-which(is.na(df$indicator) | df$indicator == "placeholder" | is.na(df$score))])
  } else {
    indicatorLength <- length(df$indicator)
  }
  
  summary_table[i, ] <- c(unique(p$bin)[i], grade, indicatorLength)
}

# PERCENT FUNDING FOR THIS AREA
com <- cost_of_mpas[which(cost_of_mpas$area == params$mpas & !(cost_of_mpas$percent_sites_in_mpa < 0.0000001)),]

if (length(com$project_id) != 0) {
  proj_titles <- sapply(com$project_id, function(pid) {
    unique(pillar_ecol_df2$project_short_title[which(pillar_ecol_df2$PPTID == pid & !(pillar_ecol_df2$indicator %in% MPAs$NAME_E))])
  })
  proj <- unique(com$project_id)
  
  # PERCENT FUNDING
  pie_area <- unique(cost_of_mpas$area)
  ps <- split(cost_of_mpas, cost_of_mpas$area)
  
  adjusted_ps <- list()
  for (i in seq_along(ps)) {
    PS <- ps[[i]]
    adjusted_ps[[i]] <- data.frame(
      project_id = PS$project_id,
      amount = rep(NA, length(PS$project_id))
    )
    for (j in seq_along(PS$project_id)) {
      keep <- which(om$project_id == PS$project_id[j])
      adjusted_ps[[i]]$amount[j] <- sum(om$amount[keep] * PS$percent_sites_in_mpa[j])
    }
  }
  
  ## QUALITY
  # QUALITY
  QUALITY_SAMPLES <- NULL
for (i in seq_along(proj)) {
quality_statements <- pillar_ecol_df2$quality_statement[which(pillar_ecol_df2$PPTID == proj[i])]
if (any(is.na(quality_statements))) {
  quality_statements <- quality_statements[-which(is.na(quality_statements))]
}

sample_years <- as.numeric(unlist(strsplit(gsub("[()]", "", unlist(regmatches(quality_statements, gregexpr("\\(([^)]+)\\)", quality_statements)))), "-")))
QUALITY_SAMPLES[[i]] <- range(sample_years, na.rm = TRUE)
}

  
  # END QUALITY
  
  final_funding <- lapply(adjusted_ps, function(x) sum(x$amount))
  
  names(final_funding) <- names(ps)
  
  bad <- which(unname(final_funding) == 0)
  
  percent_funding <- data.frame( #old df
    MPA = names(final_funding)[-bad],
    Funding = unname(unlist(final_funding))[-bad]
  ) %>%
    mutate(Funding_pct = Funding / sum(Funding))
  
  money_percentage <- round(percent_funding$Funding_pct[which(percent_funding$MPA == params$mpas)]*100, 2)
  
  proj_text <- paste0(
  proj, " (", proj_titles, ") ",
  "(", sapply(QUALITY_SAMPLES, function(x) paste(range(x), collapse = "-")), ")"
)

investment <- paste0(
  "The following DFO projects have sampled in ",
  params$mpas, " : ",
  paste(proj_text, collapse = "; "),
  " which accounted for ", money_percentage,
  "% of O&M funding to the protected areas based on the data included in this project."
)
} else {
  investment <- paste0("No identified DFO projects have sampled in ", params$mpas, " and therefore there is no identified O&M investment.")
}

# STATUS OF OBJECTIVES
if (string %in% objective_tabs$area) {
keepO <- which(objective_tabs$area %in% params$mpas)
S_Objectives <- objective_tabs$objectives[keepO]
if (!(length(S_Objectives) == 0)) {
  if (!(length(keepO) == 0)) {
    textO <- objective_tabs$objectives[keepO]
    #textO <- trimws(substr(gsub("\n", "", textO), 2, nchar(gsub("\n", "", textO))), 'both')
    # Create UI elements for objectives with bar charts
    
    filtered_odfS <- objective_tabs[objective_tabs$objectives %in% textO, ]
    
    site_grades <- NULL
    site_color <- NULL
    number_of_indicators <- NULL
    
    for (i in seq_along(filtered_odfS$objectives)) {
      KEEP <- pillar_ecol_df2[which(pillar_ecol_df2$areaID == params$mpas),]
      KEEP$score[which(!(grepl(textO[i], KEEP$objectives, fixed=TRUE)))] <- NA
      number_of_indicators[i] <- length(KEEP$indicator[KEEP$indicator != "placeholder" & !is.na(KEEP$score)])

      KEEP_df <- calc_group_score(df=KEEP,grouping_var = "bin",
                                  score_var = "score",
                                  weight_var = "weight")
      site_grades[i] <- as.character(calc_letter_grade(weighted.mean(x=KEEP_df$score, w=KEEP_df$weight, na.rm=TRUE)))
      
      
      if (!(site_grades[i] == "NA")) {
        site_color[i] <- unname(flowerPalette[which(names(flowerPalette) == site_grades[i])])
      } else {
        site_color[i] <- "#EDEDED"
      }
    }
  }
  
  status_objectives <- HTML(paste0(
    "Based on our analysis, the status of the objectives are as follows:<br><br>",
    paste0(
      paste(gsub("\n", "", filtered_odfS$objectives),
            " (", site_grades, ")", sep = ""),
      collapse = "<br><br>"
    )
  ))
} else {
  status_objectives <- "No site objective status available."
}
} else {
   status_objectives <- "No site objective status available."
}

div(
  style = "border: 2px solid black; padding: 10px; border-radius: 5px; background-color: #f9f9f9;",
  tags$p(investment),
  tags$p(status_objectives),
  tags$p(paste0(params$mpas, " has an overall ecological status score of ", area_grade, ".")),
  tags$p(paste0(
    "It should be noted that no data exists for the following ecological bins: ",
    paste0(summary_table$Indicator.Bin[which(summary_table$Grade == "NA")], collapse = ", "),
    ". Further research is recommended."
  )),
   tags$p(paste0("Data from ", params$mpas, ' has also contributed to another of other objectives including Network Objectives, Ecosystem Based Management Objectives, and Global Biodiversity Targets.'))
)


```

## At-a-glance

```{r, echo=FALSE,comment=NA, results='asis'}
cat("This protected area was established in ", MPAs$date_of_establishment[which(MPAs$NAME_E == params$mpas)], ".")
cat("<br>")
if (!(length(Context[[string]]) == 0)) {
cat(paste(Context[[string]], collapse = "<br>"), "\n")
} else {
  cat("There is no available context for this area.")
}
```


```{r, echo=FALSE, comment=NA, results="asis"}
# cat("The entirety of this report follows this legend:\n\n")
# 
# cat("<div style='display: flex; gap: 10px;'>")
# cat("<br>")
# 
# PALETTE <- append(flowerPalette,list("NA" = "#EDEDED"))
# for (name in names(PALETTE)) {
#   color <- PALETTE[name]
#   cat(sprintf("<div style='width: 50px; height: 20px; background-color: %s; text-align: center; 
#                color: black; border: 1px solid #000; line-height: 20px;'>%s</div>", 
#                color, name))
# }
# cat("</div>")
# 
# cat("<br>")
```

## Research Activity


```{r, echo=FALSE, message=FALSE, results='asis'}
apj_mpa <- all_indicator_project_geoms[which(all_indicator_project_geoms$areaID == params$mpas),]

apj_mpa_last_year <- apj_mpa[which(as.numeric(apj_mpa$year) == as.numeric(format(Sys.time(), "%Y"))-1),] 

```

```{r, echo=FALSE, results='asis'}
maps <- leaflet() %>%
  addTiles()

fill_color <- ifelse(
  is.na(MPA_report_card$grade[which(MPA_report_card$NAME_E == params$mpas)]),
  "#EDEDED",
  flowerPalette[[MPA_report_card$grade[which(MPA_report_card$NAME_E == params$mpas)]]]
)

border_color <- if (fill_color == "#ABD9E9") "black" else fill_color

maps <- maps %>% 
  addPolygons(data=MPAs$geoms[which(MPAs$NAME_E == params$mpas)], fillOpacity = 0.05, weight=2, color=border_color)



## Adding sample locations

proj_ids_samples <- apj_mpa_last_year %>%
  mutate(
    project_id = ifelse(
      is.na(PPTID),
      paste0("External: ", source),
      paste0("PPTID: ", PPTID)
    ),
    project_label = ifelse(
      is.na(PPTID),
      project_id,
      paste0(project_id, " (", project_short_title, ")")
    )
  ) %>%
  # count number of samples per project
  group_by(project_id) %>%
  mutate(n_samples = n()) %>%
  ungroup()

proj_pal <- colorFactor(
  palette = "Dark2",
  domain = proj_ids_samples$project_id
)

maps <- maps %>%
  addCircleMarkers(
    data = proj_ids_samples,
    color = ~proj_pal(project_id),
    label = ~paste0(project_id, " — ", n_samples, " samples"),
    popup = ~paste0("<b>", project_id, "</b><br>",
                    n_samples, " samples"),
    radius = 6,
    fillOpacity = 0.9
  ) %>%
  addLegend(
    "bottomright",
    pal = proj_pal,
    values = proj_ids_samples$project_id,
    title = "Projects"
  )


## END


maps

# FINDING SAMPLE INFORMATION

apj_proj <- apj_mpa %>%
  mutate(
    project_id = ifelse(
      is.na(PPTID),
      paste0("External: ", source),
      paste0("PPTID: ", PPTID)
    ),
    project_label = ifelse(
      is.na(PPTID),
      project_id,
      paste0(project_id, " (", project_short_title, ")")
    )
  )

proj_year_info <- apj_proj %>%
  sf::st_drop_geometry() %>%
  group_by(project_id, areaID) %>%
  summarise(
    has_date_info = any(!is.na(year)),
    .groups = "drop"
  )

date_of_establishment <- MPAs$date_of_establishment[MPAs$NAME_E == params$mpas]

proj_sample_counts <- apj_proj %>%
  sf::st_drop_geometry() %>%   # ← THIS fixes your error
  group_by(project_id, project_label, areaID) %>%
  summarise(
    total_samples = n(),
    .groups = "drop"
  )


proj_sample_counts <- proj_sample_counts %>%
  left_join(MPAs %>% select(NAME_E, date_of_establishment), 
            by = c("areaID" = "NAME_E")) %>%
  rowwise() %>%
  mutate(
    samples_post_doe = sum(apj_proj$year[apj_proj$project_id == project_id & 
                                         apj_proj$areaID == areaID] >= date_of_establishment,
                           na.rm = TRUE)
  ) %>%
  ungroup()

proj_sample_counts <- proj_sample_counts %>%
  left_join(proj_year_info, by = c("project_id", "areaID"))


proj_statements <- proj_sample_counts %>%
  mutate(
    sentence = paste0(
      project_label, ": ", total_samples, " samples in total; ",
      samples_post_doe, " samples taken in or after date of establishment."
    )
  )

# Combine into one paragraph
proj_statements <- proj_sample_counts %>%
  mutate(
    sentence = ifelse(
      !has_date_info,
      paste0(project_label, " collected ", total_samples,
             " samples, but no date information is available."),
      paste0(project_label, " collected ", total_samples,
             " samples in total, with ", samples_post_doe,
             " collected after the area was established.")
    )
  )

summary_sentence <- paste(proj_statements$sentence, collapse = " ")



# END SAMPLE INFORMATION

sample_statement <- paste0(
  "Sampling effort by project in ", as.numeric(format(Sys.time(), "%Y"))-1, ": ",
  paste(
    unique(paste0(proj_ids_samples$project_label,
                  " (", proj_ids_samples$n_samples, " samples)")),
    collapse = "; "
  ),
  "."
)

cat("<br>")

cat(paste0("Figure 1: Location of ", string, " color coded for overall ecological status score. Locations of data collected in ",as.numeric(format(Sys.time(), "%Y"))-1), " also included on the map.")
cat("<br>")
cat("<br>")


cat(sample_statement)
cat("<br>")

cat(paste0("Sample effort by project in total: ", summary_sentence))

```


## Creature Feature

```{r, echo = FALSE, comment=NA, results="asis", warning=FALSE}
cat(paste0("Table 1: Species detected in ", string, " according to iNaturalist"))
cat("<br>")

try({
  datatable(
    creature_feature |>
      filter(NAME_E == params$mpas) |>
      arrange(desc(n)) |>
      dplyr::select(commonname, image_column, scientificName, n, kingdom, phylum, class),

    # Disable sorting for the image column
    options = list(
      # Show 5 entries by default
      pageLength = 5,

      # Enable column-specific filtering
      initComplete = JS(
        "function(settings, json) {
          this.api().columns([1, 3, 4, 5, 6, 7]).every(function() {
            var column = this;
            var select = $('<select><option value=\"\"></option></select>')
              .appendTo($(column.footer()).empty())
              .on('change', function() {
                var val = $.fn.dataTable.util.escapeRegex(
                  $(this).val()
                );

                column
                  .search(val ? '^' + val + '$' : '', true, false)
                  .draw();
              });

            column.data().unique().sort().each(function(d, j) {
              select.append('<option value=\"' + d + '\">' + d + '</option>')
            });
          });
        }"
      )
    ),

    # Specify column names
    colnames = c(
      "Common Name",
      "Example Image",
      "Scientific Name",
      "iNaturalist Observations",
      "Kingdom",
      "Phylum",
      "Class"
    ),

    # Escape HTML to allow image rendering
    escape = FALSE,

    # Add some styling
    class = 'cell-border stripe hover',

    # Add footer for filtering
    filter = "bottom"
  )
})
```

## Results

<details>
<summary style="
    font-size: 1.5em;       /* make the text bigger */
    font-weight: bold;       /* make it bold */
    cursor: pointer;         /* show pointer on hover */
">
MANAGEMENT EFFECTIVENESS
</summary>

```{r, echo=FALSE, results='asis', warning=FALSE}
cat("<br>")
cat("Management Effectiveness summarizes how well a site is performing against its stated conservation objectives, based on the best available indicators and data.")
cat("<br>")
cat("For each conservation objective, relevant indicators are grouped and scored to provide an overall assessment of progress toward that objective. These scores are intended to support interpretation and comparison, not to represent a definitive measure of success or failure.")
cat("<br>")
cat("Where data are limited or unavailable, this is explicitly indicated and reflected in the resulting score. As such, scores should be interpreted in the context of data availability, indicator coverage, and monitoring effort, and not as a complete or final evaluation of management outcomes.")
cat("<br>")
gradeLegendUI("objective")
cat("<br>")
```

```{r, echo=FALSE,comment=NA, results="asis", warning=FALSE}
cat('<h3>Site Conservation Objectives</h2>\n')
cat('Select each objective to see information on relevant indicators.\n')

if (exists("S_Objectives")) {
if (!(length(S_Objectives) == 0)) {
  
  dt_data <- data.frame(
    Objective = filtered_odfS$objectives,
    Grade = site_grades,
    Number_Of_Indicators = number_of_indicators,
    stringsAsFactors = FALSE
  )
  
return(datatable(dt_data, rownames = FALSE) %>%
  formatStyle(
    'Grade',
    target = 'cell',
    backgroundColor = styleEqual(
      c(names(flowerPalette), "NA"),
      c(flowerPalette, "#EDEDED")
    ),
    color = 'black' # optional: adjust if needed for contrast
  ))

cat('<br>\n')

} else {
  cat("There are no site objectives pulled with our tools for this area.")
}
} else {
  cat("There are no site objectives pulled with our tools for this area.")

}
```


```{r, echo=FALSE, comment=NA, results="asis", warning=FALSE}
if (exists("textO")) {
for (i in seq_along(textO)) {
  
cat(sprintf(
  '<details>
     <summary style="
        cursor: pointer;
        font-weight: bold;
        font-size: 1.1em;
        padding: 4px 8px;
        border-radius: 4px;
        margin-bottom: 5px;">
        <u>Objective: %s <span style="background-color:%s; padding:2px 6px; border-radius:4px;">%s</span></u>
     </summary>\n\n',
  toupper(textO[i]),        # objective text
  site_color[i],            # background color only for grade
  ifelse(!(dt_data$Grade[i] == "NA"), dt_data$Grade[i], "  ")          # grade to display
))
  k1 <- which(grepl(textO[i], pillar_ecol_df2$objectives, fixed=TRUE))
  if (params$mpas %in% regions$NAME_E) {
    k2 <- k1
  } else {
    k2 <- which(pillar_ecol_df2$areaID == params$mpas)
  }
  keep <- intersect(k1,k2)
  keep_na <- NULL
  
  if (!(length(keep) == 0)) {
    if (any(is.na(pillar_ecol_df2$score[keep]))) {
      keep_na <- keep[which(is.na(pillar_ecol_df2$score[keep]))]
    }
    
    keep <- keep[which(!is.na(pillar_ecol_df2$score[keep]))]
  
    
    # Flower plot for objectives
    
    objective_flower <- pillar_ecol_df2[k2,]
    objective_flower$score[which(!(grepl(textO[i], objective_flower$objectives, fixed=TRUE)))] <- NA
    if (!(length(keep) == 0)) {
    cat("The objective has the following score: \n")
    cat("<br>")
    }


    if (!(all(is.na(objective_flower$score)))) {
    pp <- MarConsNetAnalysis::plot_flowerplot(objective_flower,
                                            grouping = "objective",
                                            labels = "bin",
                                            score = "score",
                                            max_score=100,
                                            min_score=0,
                                            title=" ",
                                            showNumbers = TRUE)
    print(pp)
    cat("<br>")
    
    # NOW DO THE SO-WHAT
    grade_text <- grade_description('objective')[[dt_data$Grade[i]]]
    n_indicators <- length(which(!(is.na(objective_flower$score))))
    
      years <- str_extract(unique(str_extract(objective_flower$quality_statement, "\\(([^)]*)\\)")), "(?<=-)[0-9]+")
      years_num <- as.numeric(years)
      latest_year <- ifelse(length(years_num) > 0 && any(!is.na(years_num)),max(years_num, na.rm = TRUE),NA)
      
      weighted_outside_grade <- calc_letter_grade(
          weighted.mean(objective_flower$adjacent_score, objective_flower$weight, na.rm = TRUE)
        )
      
              n_indicators_outside <- length(unique(objective_flower$objective[!is.na(objective_flower$adjacent_score)]))

        
        

        sowhat <- paste0(
          "This objective has a score of ", grade_text,
          " indicating ", tolower(grade_text), ".",

          if (n_indicators < 4) {
            paste0(" It should be noted that this assessment is only based on the score of ", n_indicators, " unique indicators and further research is recommended.")
          } else {
            paste0(" This assessment is based on ", n_indicators, " indicators.")
          },

          if (!is.na(latest_year)) {
            paste0(" The latest data we have that supports this objective is as of ", latest_year, ".")
          } else {
            " "
          })
        
        
          if (!(all(is.na(objective_flower$adjacent_score)))) {
            sowhatoutside <- paste0(" For context, outside of the protected area has scored a ", weighted_outside_grade, ' indicating ',
                                    tolower(grade_description('objective')[[weighted_outside_grade]]), ". This outside assessment is based on
                                    ",n_indicators_outside, " indicators.")
          } else {
            sowhatoutside <- ""
          }
        
        cat(sowhat)
        cat("<br>")
        cat(sowhatoutside)
        cat("<br>")
    }
        cat("<br>")
if (!(length(keep) == 0)) {
    cat("Below highlights the list of indicators used to inform each objective: \n")
}

    cat("<br>")
    cat("<br>")


    
    # end flower plot
if (!(length(keep) == 0)) {
  for (j in seq_along(keep)) {
 # cat(sprintf(
 #    "<details>\n<summary><b>Indicator: %s</b></summary>\n\n",
 #    pillar_ecol_df2$indicator[keep[j]]
 #  ))
 #    
    # FINDING PLOT
      keep1 <- which(grepl(make.names(params$mpas), image_files, ignore.case=TRUE, fixed=TRUE)) # Which are from the correct area
      keep2 <- which(grepl(make.names(pillar_ecol_df2$indicator[keep[j]]), image_files, ignore.case=TRUE, fixed=TRUE)) # Which ones have the correct indicator name
      KEEP <- intersect(keep1,keep2)
cat(sprintf(
  '<details>
     <summary style="
        cursor: pointer;
        font-weight: bold;
        font-size: 1.1em;
        padding: 4px 6px;
        border-radius: 4px;
        margin-bottom: 5px;">
        Indicator: %s <span style="background-color:%s; color:white; padding:2px 6px; border-radius:4px;">%s</span>
     </summary>\n\n',
  pillar_ecol_df2$indicator[keep[j]],
  ifelse(is.na(pillar_ecol_df2$score[keep[j]]) | pillar_ecol_df2$score[keep[j]] == "NA", "#EDEDED", unname(flowerPalette[calc_letter_grade(pillar_ecol_df2$score[keep[j]])])),
  ifelse(is.na(pillar_ecol_df2$score[keep[j]]) | pillar_ecol_df2$score[keep[j]] == "NA", " ", round(pillar_ecol_df2$score[keep[j]],0))
))
      
      if (length(KEEP) > 1) {
        KEEP <- KEEP[which(sub(".*_(.*?)\\.png$", "\\1", image_files[KEEP]) == pillar_ecol_df2$indicator[keep[j]])]
      }
      plot_file <- image_files[KEEP]
    
    # END PLOT
      if (length(plot_file) > 0) {
          for (p in seq_along(plot_file)) {
    
    # Read the image
    img <- image_read(plot_file[p])
    
    # Get image info
    info <- image_info(img)
    
    # Crop 10% from top and bottom (keep 80% of height)
    crop_height <- info$height * 0.6
    img_cropped <- image_crop(
      img,
      geometry = geometry_area(
        width = info$width,
        height = crop_height,
        x = 0,
        y = info$height * 0.1  # start 10% down
      )
    )
    
    # Overwrite original file or create temp file
    tmp_file <- tempfile(fileext = ".png")
    image_write(img_cropped, path = tmp_file)
    
    # Embed cropped image
    cat(sprintf(
      '<img src="%s" style="width:600px; display:block; margin:0; padding:0;" />\n\n',
      tmp_file
    ))
    
          }
        
      } else {
        cat("There is no image available for this indicator as it was not sampled in this area.")
        cat("<br>")
      }
      
      if (is.na(pillar_ecol_df2$trend_statement[keep[j]])) {
        trendy <- "No temporal analysis completed for this indicator."
      } else if (!(pillar_ecol_df2$trend_statement[keep[j]] == "There is no temporal dimension in this data.")) {
      trendy <- pillar_ecol_df2$trend_statement[keep[j]]
      } else {
        trendy <- pillar_ecol_df2$trend_statement[keep[j]]
      }
      
      
      
      table_df <- data.frame(
        "Assumptions"=pillar_ecol_df2$assumptions[keep[j]],
        "Caveats"=pillar_ecol_df2$caveats[keep[j]],
        "Rationale"=pillar_ecol_df2$indicator_rationale[keep[j]],
                             "Status"=pillar_ecol_df2$status_statement[keep[j]],
                             "Trend"= trendy,
                             "Score"= round(pillar_ecol_df2$score[keep[j]],0),
                             "Scoring_Scheme"=pillar_ecol_df2$scoring[keep[j]],
                             "Source"=ifelse(is.na(pillar_ecol_df2$PPTID[keep[j]]), pillar_ecol_df2$source[keep[j]], pillar_ecol_df2$project_short_title[keep[j]]),
                             "Quality"= pillar_ecol_df2$quality_statement[keep[j]]
      )
      
      
      
## Adding indicator so-what
      weighted_grade_ind <-  calc_letter_grade(
          weighted.mean(pillar_ecol_df2$score[keep[j]], pillar_ecol_df2$weight[keep[j]], na.rm = TRUE)
        )
if (!(weighted_grade_ind == "NA")) {
          grade_text <- grade_description('indicator')[[calc_letter_grade(pillar_ecol_df2$score[keep[j]])]]
          
          
           years_ind <- as.numeric(str_extract(unique(str_extract(pillar_ecol_df2$quality_statement[keep[j]], "\\(([^)]*)\\)")), "(?<=-)[0-9]+"))
      latest_year_ind <- ifelse(length(years_ind) > 0 && any(!is.na(years_ind)),max(years_ind, na.rm = TRUE),NA)
          
          
          } else {
            grade_text <- 'more information is needed for this indicator'
          }

          sowhatind <- paste0(
            pillar_ecol_df2$indicator[keep[j]], " has a score of ", calc_letter_grade(pillar_ecol_df2$score[keep[j]]),
            " indicating ", tolower(grade_text)," in ", pillar_ecol_df2$areaID[keep[j]], ".",
            if (!is.na(latest_year_ind)) {
              paste0(" The latest data we have that supports this objective is as of ", latest_year_ind, ".")
            } else {
              " "
            })
          
          cat(sowhatind)
          cat("<br>")

          if (!(state$mpas %in% regions$NAME_E)) {
            if (!(all(is.na(pillar_ecol_df2$adjacent_score[keep[j]])))) {
              weighted_outside_grade_ind <- calc_letter_grade(
          weighted.mean(pillar_ecol_df2$adjacent_score[keep[j]], pillar_ecol_df2$weight[keep[j]], na.rm = TRUE)
        )
              sowhatoutsideind <- paste0(" For context, outside of the protected area has scored a ", weighted_outside_grade_ind, ' indicating ', tolower(grade_description('indicator')[[weighted_outside_grade_ind]]), ".")
            
               cat(sowhatoutsideind)
          cat("<br>")
              
              }
          }      
      
      
# END indicator so what
      
      cat(knitr::kable(
  table_df,
  format = "html",
  table.attr = 'style="width:80%; margin-left:auto; margin-right:auto; border-collapse:collapse;"'
) %>%
  kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center"
  ),
  "\n\n"
)

cat("</details>\n\n")  # close the collapsible

  
  }
  } else {
        cat("There are no indicators in this area that support this objective")

  }
  } else {
    cat("There are no indicators in this area that support this objective")
  }
    if (!(is.null(keep_na))) {
          cat("<br>")

  cat("The following indicators were identified as indicators that inform this objective, but we do not yet have data for.")
  cat("<br>")
  cat(paste0(pillar_ecol_df2$indicator[keep_na], collapse=", "))
    }
    cat("<br>")
    cat("<br>")


  cat("</details>\n\n")
  
}

cat('<br>\n')



}
```

</details> <details>
<summary style="
    font-size: 1.5em;       /* make the text bigger */
    font-weight: bold;       /* make it bold */
    cursor: pointer;         /* show pointer on hover */
">
BONUS CONTRIBUTIONS
</summary>

```{r, echo=FALSE, results='asis', warning=FALSE}
cat("Effectiveness Contributions summarizes indicators for conservation objectives that the site is not directly managed for. While the site is not managed with these objectives in mind, protection and management can still influence outcomes.")
cat("<br>")
cat("Scores reflect the actual status of each indicator, showing how well the objective is being met, even if indirectly. These scores are intended for interpretation and comparison, and do not represent a direct management outcome.")
cat("<br>")
cat("Where data are limited or unavailable, this is explicitly indicated. Scores should always be interpreted in the context of data availability, coverage, and monitoring effort.")
cat("<br>")
gradeLegendUI("objective")
cat("<br>")

cat('<h3>Network Conservation Objectives</h2>\n')

cat('Click each objective to see information on relevant indicators.')

n_objectives <- trimws(substr(gsub("\n", "", N_Objectives), 2, nchar(gsub("\n", "", N_Objectives))), 'both')
filtered_odf <- objective_tabs[which(objective_tabs$objectives %in% n_objectives),]

grades_network <- NULL
grade_colors_network <- NULL
number_of_indicators_network <- NULL

for (i in seq_along(filtered_odf$objectives)) {
  # GRADES
  if (params$mpas %in% MPAs$NAME_E) {
    KEEP <- pillar_ecol_df2[which(pillar_ecol_df2$areaID == params$mpas),]
  } else {
   KEEP <- pillar_ecol_df2[which(pillar_ecol_df2$areaID %in% MPAs$NAME_E),]
  }
  KEEP$score[which(!(grepl(n_objectives[i], KEEP$objectives, fixed=TRUE)))] <- NA

  KEEP_df <- calc_group_score(df=KEEP,grouping_var = "bin",
                               score_var = "score",
                               weight_var = "weight")
  number_of_indicators_network[i] <- length(!(is.na(unique(KEEP$score))))
  grades_network[i] <- as.character(calc_letter_grade(weighted.mean(x=KEEP_df$score, w=KEEP_df$weight, na.rm=TRUE)))
  
  if (!(all(is.na(KEEP$score)))) {
    grade_colors_network[i] <- unname(flowerPalette[which(names(flowerPalette) == grades_network[i])])
  } else {
    grade_colors_network[i] <- "#EDEDED"
  }
}

dt_data_network <- data.frame(
  Objective = filtered_odf$objectives,
  Grade = grades_network,
  Number_Of_Indicators=number_of_indicators_network,
  stringsAsFactors = FALSE
)

return(datatable(dt_data_network, rownames = FALSE) %>%
           formatStyle(
               'Grade',
               target = 'cell',
               backgroundColor = styleEqual(
                   c(names(flowerPalette), "NA"),
                   c(flowerPalette, "#EDEDED")
               ),
               color = 'black' # optional: adjust if needed for contrast
           ))

cat("<br>")

```


```{r, echo=FALSE, comment=NA, results='asis', warning=FALSE}
for (i in seq_along(n_objectives)) {
cat(sprintf(
 '<details>
     <summary style="
        cursor: pointer;
        font-weight: bold;
        font-size: 1.1em;
        padding: 4px 8px;
        border-radius: 4px;
        margin-bottom: 5px;">
        <u>Objective: %s <span style="background-color:%s; padding:2px 6px; border-radius:4px;">%s</span></u>
     </summary>\n\n',
  toupper(n_objectives[i]),      # objective text
  grade_colors_network[i],       # background color only for grade
  ifelse(!(grades_network[i] == "NA"), grades_network[i], "  ") 
)) 
  
  k1 <- which(grepl(n_objectives[i], pillar_ecol_df2$objectives, fixed=TRUE))
  if (params$mpas %in% regions$NAME_E) {
    k2 <- k1
  } else {
    k2 <- which(pillar_ecol_df2$areaID == params$mpas)
  }
  keep <- intersect(k1,k2)
  
  keep_na <- NULL
  
  if (!(length(keep) == 0)) {
    if (any(is.na(pillar_ecol_df2$score[keep]))) {
      keep_na <- keep[which(is.na(pillar_ecol_df2$score[keep]))]
    }
    
    keep <- keep[which(!is.na(pillar_ecol_df2$score[keep]))]
    
  
  
  if (!(length(keep) == 0)) {
      if (any(is.na(pillar_ecol_df2$score[keep]))) {
      keep_na <- keep[which(is.na(pillar_ecol_df2$score[keep]))]
    }
    
    keep <- keep[which(!is.na(pillar_ecol_df2$score[keep]))]
    
    
    # FLOWER
    objective_flower <- pillar_ecol_df2[k2,]
    objective_flower$score[which(!(grepl(n_objectives[i], objective_flower$objectives, fixed=TRUE)))] <- NA
    
    #cat("The objective has the following score: \n")
    cat("<br>")

    
    p <- MarConsNetAnalysis::plot_flowerplot(objective_flower,
                                            grouping = "objective",
                                            labels = "bin",
                                            score = "score",
                                            max_score=100,
                                            min_score=0,
                                            title=" ",
                                            showNumbers = TRUE)
    print(p)
    cat("<br>")
    cat("<br>")
    # TEST
    # NOW DO THE SO-WHAT
    grade_text <- grade_description('objective')[[dt_data_network$Grade[i]]]
    n_indicators <- length(which(!(is.na(objective_flower$score))))
    
      years <- str_extract(unique(str_extract(objective_flower$quality_statement, "\\(([^)]*)\\)")), "(?<=-)[0-9]+")
      years_num <- as.numeric(years)
      latest_year <- ifelse(length(years_num) > 0 && any(!is.na(years_num)),max(years_num, na.rm = TRUE),NA)
      
      weighted_outside_grade <- calc_letter_grade(
          weighted.mean(objective_flower$adjacent_score, objective_flower$weight, na.rm = TRUE)
        )
      
      n_indicators_outside <- length(unique(objective_flower$objective[!is.na(objective_flower$adjacent_score)]))
              
        sowhat <- paste0(
          "This objective has a score of ", grade_text,
          " indicating ", tolower(grade_text), ".",

          if (n_indicators < 4) {
            paste0(" It should be noted that this assessment is only based on the score of ", n_indicators, " unique indicators and further research is recommended.")
          } else {
            paste0(" This assessment is based on ", n_indicators, " indicators.")
          },

          if (!is.na(latest_year)) {
            paste0(" The latest data we have that supports this objective is as of ", latest_year, ".")
          } else {
            " "
          })
        
        
          if (!(all(is.na(objective_flower$adjacent_score)))) {
            sowhatoutside <- paste0(" For context, outside of the protected area has scored a ", weighted_outside_grade, ' indicating ',
                                    tolower(grade_description('objective')[[weighted_outside_grade]]), ". This outside assessment is based on
                                    ",n_indicators_outside, " indicators.")
          } else {
            sowhatoutside <- ""
          }
        
        cat(sowhat)
        cat("<br>")
        cat(sowhatoutside)
        cat("<br>")
    }
        cat("<br>")
        
    
    
    # END TEST
    
    cat("<br>")
    cat("<br>")

    cat("Below highlights the list of indicators used to inform each objective: \n")
    cat("<br>")
    cat("<br>")
  for (j in seq_along(keep)) {
    #cat(sprintf("<b>Indicator: %s.</b>\n\n", pillar_ecol_df2$indicator[keep[j]]))
    
    # FINDING PLOT
      keep1 <- which(grepl(make.names(params$mpas), image_files, ignore.case=TRUE, fixed=TRUE)) # Which are from the correct area
      keep2 <- which(grepl(make.names(pillar_ecol_df2$indicator[keep[j]]), image_files, ignore.case=TRUE, fixed=TRUE)) # Which ones have the correct indicator name
      KEEP <- intersect(keep1,keep2)
      
      if (length(KEEP) > 1) {
        KEEP <- KEEP[which(sub(".*_(.*?)\\.png$", "\\1", image_files[KEEP]) == pillar_ecol_df2$indicator[keep[j]])]
      }
      
      cat(sprintf(
  '<details>
     <summary style="
        cursor: pointer;
        font-weight: bold;
        font-size: 1.1em;
        padding: 4px 6px;
        border-radius: 4px;
        margin-bottom: 5px;">
        Indicator: %s <span style="background-color:%s; color:white; padding:2px 6px; border-radius:4px;">%s</span>
     </summary>\n\n',
  pillar_ecol_df2$indicator[keep[j]],
  ifelse(is.na(pillar_ecol_df2$score[keep[j]]) | pillar_ecol_df2$score[keep[j]] == "NA", "#EDEDED", unname(flowerPalette[calc_letter_grade(pillar_ecol_df2$score[keep[j]])])),
  ifelse(is.na(pillar_ecol_df2$score[keep[j]]) | pillar_ecol_df2$score[keep[j]] == "NA", " ", round(pillar_ecol_df2$score[keep[j]],0))
))
      
      plot_file <- image_files[KEEP]
    
    # END PLOT
      if (length(plot_file) > 0) {
      for (p in seq_along(plot_file)) {
         img <- image_read(plot_file[p])
    
    # Get image info
    info <- image_info(img)
    
    # Crop 10% from top and bottom (keep 80% of height)
    crop_height <- info$height * 0.6
    img_cropped <- image_crop(
      img,
      geometry = geometry_area(
        width = info$width,
        height = crop_height,
        x = 0,
        y = info$height * 0.1  # start 10% down
      )
    )
    
    # Overwrite original file or create temp file
    tmp_file <- tempfile(fileext = ".png")
    image_write(img_cropped, path = tmp_file)
    
    # Embed cropped image
    cat(sprintf(
      '<img src="%s" style="width:600px; display:block; margin:0; padding:0;" />\n\n',
      tmp_file
    ))
      }
      } else {
        cat("There is no image available for this indicator as it was not sampled in this area.")
        cat("<br>")
      }

      if (is.na(pillar_ecol_df2$trend_statement[keep[j]])) {
        trendy <- "No temporal analysis completed for this indicator."
      } else if (!(pillar_ecol_df2$trend_statement[keep[j]] == "There is no temporal dimension in this data.")) {
      trendy <- pillar_ecol_df2$trend_statement[keep[j]]
      } else {
        trendy <- pillar_ecol_df2$trend_statement[keep[j]]
      }
      
      table_df <- data.frame(
        "Assumptions"=pillar_ecol_df2$assumptions[keep[j]],
        "Caveats"=pillar_ecol_df2$caveats[keep[j]],
        "Rationale"=pillar_ecol_df2$indicator_rationale[keep[j]],
                             "Status"=pillar_ecol_df2$status_statement[keep[j]],
                             "Trend"= trendy,
                             "Score"= round(pillar_ecol_df2$score[keep[j]],0),
                             "Scoring_Scheme"=pillar_ecol_df2$scoring[keep[j]],
                             "Source"=ifelse(is.na(pillar_ecol_df2$PPTID[keep[j]]), pillar_ecol_df2$source[keep[j]], pillar_ecol_df2$project_short_title[keep[j]])
      )
      
      ## Adding indicator so-what
      weighted_grade_ind <-  calc_letter_grade(
          weighted.mean(pillar_ecol_df2$score[keep[j]], pillar_ecol_df2$weight[keep[j]], na.rm = TRUE)
        )
if (!(weighted_grade_ind == "NA")) {
          grade_text <- grade_description('indicator')[[calc_letter_grade(pillar_ecol_df2$score[keep[j]])]]
          
          
           years_ind <- as.numeric(str_extract(unique(str_extract(pillar_ecol_df2$quality_statement[keep[j]], "\\(([^)]*)\\)")), "(?<=-)[0-9]+"))
      latest_year_ind <- ifelse(length(years_ind) > 0 && any(!is.na(years_ind)),max(years_ind, na.rm = TRUE),NA)
          
          
          } else {
            grade_text <- 'more information is needed for this indicator'
          }

          sowhatind <- paste0(
            pillar_ecol_df2$indicator[keep[j]], " has a score of ", calc_letter_grade(pillar_ecol_df2$score[keep[j]]),
            " indicating ", tolower(grade_text)," in ", pillar_ecol_df2$areaID[keep[j]], ".",
            if (!is.na(latest_year)) {
              paste0(" The latest data we have that supports this objective is as of ", latest_year_ind, ".")
            } else {
              " "
            })
          
          cat(sowhatind)
          cat("<br>")

          if (!(state$mpas %in% regions$NAME_E)) {
            if (!(all(is.na(pillar_ecol_df2$adjacent_score[keep[j]])))) {
              weighted_outside_grade_ind <- calc_letter_grade(
          weighted.mean(pillar_ecol_df2$adjacent_score[keep[j]], pillar_ecol_df2$weight[keep[j]], na.rm = TRUE)
        )
              sowhatoutsideind <- paste0(" For context, outside of the protected area has scored a ", weighted_outside_grade_ind, ' indicating ', tolower(grade_description('indicator')[[weighted_outside_grade_ind]]), ".")
            
               cat(sowhatoutsideind)
          cat("<br>")
              
              }
          }      
      
      
# END indicator so what
      
      cat(knitr::kable(
  table_df,
  format = "html",
  table.attr = 'style="width:80%; margin-left:auto; margin-right:auto; border-collapse:collapse;"'
) %>%
  kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center"
  ),
  "\n\n"
)
           cat("</details>\n\n")  # close the collapsible

  }
  } else {
    cat("There are no indicators in this area that support this objective")
  }
  
   if (!(is.null(keep_na))) {
          cat("<br>")

  cat("The following indicators were identified as indicators that inform this objective, but we do not yet have data for.")
  cat("<br>")
  cat(paste0(pillar_ecol_df2$indicator[keep_na], collapse=", "))
   }
  cat("<br>")
  cat("<br>")
  
    cat("</details>\n\n")
}
  cat("<br>")
  cat("<br>")

```

</details> <details>
<summary style="
    font-size: 1.5em;       /* make the text bigger */
    font-weight: bold;       /* make it bold */
    cursor: pointer;         /* show pointer on hover */
">
ECOLOGICAL OVERVIEW
</summary>


```{r, echo=FALSE, comment=NA, results="asis", warning=FALSE}
cat("<br>")
cat("The Ecosystem Overview tab presents all indicators measured in the selected area, regardless of whether they contribute to specific conservation objectives. ")
cat("<br>")
cat("The flowerplot provides a visual summary of overall ecosystem health. Scores here reflect the integrated condition of the ecosystem based on all available indicators: ")
cat("<br>")
gradeLegendUI("ecosystem_health")
cat("<br>")

cat('Ecological overview analyses the health of the overall ecosystem\n\n')

plot_flowerplot(pillar_ecol_df2[which(pillar_ecol_df2$areaID == params$mpas),],
                                            grouping = "objective",
                                            labels = "bin",
                                            score = "score",
                                            max_score=100,
                                            min_score=0,
                                            title="Flower plot framework", showNumbers = TRUE)

subset_ped <- pillar_ecol_df2[which(pillar_ecol_df2$areaID == params$mpas),]
grade_text <- grade_description('ecosystem_health')[[calc_letter_grade(weighted.mean(subset_ped$score, subset_ped$weight, na.rm=TRUE))]]
    n_indicators <- length(which(!(is.na(subset_ped$score))))
    
      years <- str_extract(unique(str_extract(subset_ped$quality_statement, "\\(([^)]*)\\)")), "(?<=-)[0-9]+")
      years_num <- as.numeric(years)
      latest_year <- ifelse(length(years_num) > 0 && any(!is.na(years_num)),max(years_num, na.rm = TRUE),NA)
      
      weighted_outside_grade <- calc_letter_grade(
          weighted.mean(subset_ped$adjacent_score, subset_ped$weight, na.rm = TRUE)
        )
      
              n_indicators_outside <- length(unique(subset_ped$objective[!is.na(subset_ped$adjacent_score)]))

        
        
cat("<br>")
        sowhat <- paste0(
          "This objective has a score of ", grade_text,
          " indicating ", tolower(grade_text), ".",

          if (n_indicators < 4) {
            paste0(" It should be noted that this assessment is only based on the score of ", n_indicators, " unique indicators and further research is recommended.")
          } else {
            paste0(" This assessment is based on ", n_indicators, " indicators.")
          },

          if (!is.na(latest_year)) {
            paste0(" The latest data we have that supports this objective is as of ", latest_year, ".")
          } else {
            " "
          })
        
        
          if (!(all(is.na(subset_ped$adjacent_score)))) {
            sowhatoutside <- paste0(" For context, outside of the protected area has scored a ", weighted_outside_grade, ' indicating ',
                                    tolower(grade_description('ecosystem_health')[[weighted_outside_grade]]), ". This outside assessment is based on
                                    ",n_indicators_outside, " indicators.")
          } else {
            sowhatoutside <- ""
          }
        
        cat(sowhat)
        cat("<br>")
        cat(sowhatoutside)
        cat("<br>")
        cat("<br>")
```


```{r, echo=FALSE, results='asis',warning=FALSE}
if (params$mpas %in% regions$NAME_E) {
  table_ped <- pillar_ecol_df2[which(!(pillar_ecol_df2$areaID %in% regions$NAME_E)),]
  
} else {
  table_ped <- pillar_ecol_df2[which(pillar_ecol_df2$areaID == params$mpas),]
}
if (any(table_ped$indicator == "placeholder") | any(is.na(table_ped$indicator))) {
  table_ped <- table_ped[-which(table_ped$indicator == 'placeholder' | is.na(table_ped$indicator)),]
}

table_ped <- table_ped[,c("bin", "indicator", "source", "score", "weight", "PPTID", "readiness", "quality_statement")]


ddff <- table_ped %>%
  left_join(
    Ecological %>% dplyr::select(labels, grouping),
    by = c("bin" = "labels")   # bin in table_ped matches labels in Ecological
  ) %>%
  # Add placeholders for readiness, quality, cost
  mutate(
    cost      = NA_real_
  ) %>%
  dplyr::select(grouping, bin, indicator, source, score, readiness, quality_statement, cost, PPTID) %>%
  arrange(grouping, bin) %>%
  setNames(toupper(names(.)))


  ddff_unique <- ddff

if (!(length(ddff_unique$PPTID) == 0)) {
  costing <- NULL
  for (i in seq_along(unique(ddff_unique$PPTID))) {
    ppt <- unique(ddff_unique$PPTID)[i]
    if (is.na(ppt)) {
      costing[i] <- "External"
      ddff_unique$COST[which(is.na(ddff_unique$PPTID))] <- "External"
    } else {
      costing[i] <- paste0("$", round(unique(cost_of_mpas$price_per_station[which(cost_of_mpas$project_id == ppt)]),2), "/ sample")
      ddff_unique$COST[which(ddff_unique$PPTID == unique(ddff_unique$PPTID)[i])] <- paste0("$", round(unique(cost_of_mpas$price_per_station[which(cost_of_mpas$project_id == ppt)]),2), "/ sample")
      
    }
  }
   ddff_display <- ddff_unique %>%
        arrange(GROUPING, SOURCE) %>%                # make sure sources are together within grouping
        group_by(GROUPING, SOURCE) %>%
        mutate(COST = ifelse(row_number() == 1, COST, "")) %>%  # only first row of each SOURCE shows COST
        ungroup()
 }

```


```{r, echo=FALSE, comment=NA, results="asis",warning=FALSE}
library(knitr)
library(leaflet)
bin_na_indicators <- NULL

keeper <- pillar_ecol_df2[which(pillar_ecol_df2$areaID == params$mpas), ]

BINS <- unique(trimws(tolower(unlist(
  strsplit(keeper$bin, ";")
)), "both"))

keeper2 <- NULL

for (i in seq_along(BINS)) {
  KK <- keeper[which(grepl(BINS[i], trimws(tolower(
    keeper$bin
  ), "both"))), ]
  
  # Remove NA and placeholder indicators
  
  if (any(is.na(KK$indicator) | KK$indicator == "placeholder" | is.na(KK$score))) {
    KK <- KK[-(which(is.na(KK$indicator) | KK$indicator == "placeholder" | is.na(KK$score))),]
  }
  
  # JAIM
  
  keeper2[[i]] <- data.frame(
    Indicator = KK$indicator,
    Status = KK$status_statement,
    Trend = KK$trend_statement,
    #Plot = KK$plot,
    Grade = KK$score,
    Project = KK$PPTID,
    Source = KK$source,
    Rationale=KK$indicator_rationale,
    Scheme=KK$scoring,
    Title=KK$project_short_title,
    weight = KK$weight,
    assumptions=KK$assumptions,
    caveats=KK$caveats,
    quality=KK$quality_statement,
    adjacent_score=KK$adjacent_score,
    stringsAsFactors = FALSE
  )
  
}

names(keeper2) <- BINS

#cat('Click each indicator to see information on relevant indicators.\n')

for (i in seq_along(keeper2)) {
  # TEST
  if (!(length(keeper2[[i]]$Trend) == 0)) {
  keeper2[[i]]$bin <- names(keeper2)[i]
  GRADE <- calc_group_score(df=keeper2[[i]],grouping_var = "bin",
                               score_var = "Grade",
                               weight_var = "weight")
  BIN_GRADE <- as.character(calc_letter_grade(weighted.mean(x=GRADE$score, w=GRADE$weight, na.rm=TRUE)))
  GRADE_COLOR <- unname(flowerPalette[BIN_GRADE])
  } else {
    BIN_GRADE <- NA
    GRADE_COLOR <- "#EDEDED"
  }

  cat(sprintf(
  '<details>
     <summary style="
        cursor: pointer;
        font-weight: bold;
        font-size: 1.2em;
        padding: 4px 8px;
        border-radius: 4px;
        margin-bottom: 5px;">
        <u>%s <span style="background-color:%s; padding:2px 6px; border-radius:4px;">%s</span></u>
     </summary>\n\n',
  toupper(BINS[i]),      # objective text
  GRADE_COLOR,       # background color only for grade
  ifelse(!(is.na(BIN_GRADE)), BIN_GRADE, "  ")
  #BIN_GRADE              # grade to display
))
  
  if (!(length(keeper2[[i]]$Indicator) == 0)) {
    bin_display <- ddff_display[which(toupper(ddff_display$BIN) == toupper(names(keeper2)[i])),]
    
    if (any(is.na(bin_display$SCORE))) {
      bin_na_indicators <- bin_display$INDICATOR[is.na(bin_display$SCORE)]
      bin_display <- bin_display[-which(is.na(bin_display$SCORE)),]
    }
    
    # SUMMARY TABLE
       cat('<h4 style="text-align:left; margin-bottom:10px;">Table: Ecological Overview Summary</h4>\n')
cat('<table border="1" style="border-collapse:collapse; width:100%;">\n')
cat('<thead><tr>',
    paste0('<th>', c("GROUPING", "BIN", "INDICATOR", "SOURCE", "SCORE", "GRADE", "READINESS", "QUALITY_STATEMENT", "COST"), '</th>', collapse=""),
    '</tr></thead>\n')
cat('<tbody>\n')
for (b in seq_len(nrow(bin_display))) {
  # Compute grade
  grade <- calc_letter_grade(bin_display$SCORE[b])

  # Determine cell color (blank or color)
  if (!is.na(grade) && grade != "NA") {
    grade_color <- flowerPalette[[grade]]
  } else {
    grade_color <- "#EDEDED"
  }

  # Start row (no background color!)
  cat('<tr>')

  cat('<td>', bin_display$GROUPING[b], '</td>')
  cat('<td>', bin_display$BIN[b], '</td>')
  cat('<td>', bin_display$INDICATOR[b], '</td>')
  cat('<td>', bin_display$SOURCE[b], '</td>')
  cat('<td>', sprintf("%.2f", bin_display$SCORE[b]), '</td>')

  # ✅ Grade column — blank cell but color-coded background
  cat(sprintf('<td style="background-color:%s; font-weight:bold; text-align:center;">%s</td>',
              grade_color,
              ""))  # empty string, but could be grade if you want to show it

  cat('<td>', bin_display$READINESS[b], '</td>')
  cat('<td>', bin_display$QUALITY_STATEMENT[b], '</td>')
  cat('<td>', bin_display$COST[b], '</td>')

  cat('</tr>\n')
}

cat('</tbody></table>')



# END SUMMARY TABLE
    
  for (j in seq_along(keeper2[[i]]$Indicator)) {
    #cat(sprintf("<b>Indicator: %s.</b>\n\n", keeper2[[i]]$Indicator[j]))
    
    # FINDING PLOT
      k1 <- which(grepl(make.names(params$mpas), image_files, ignore.case=TRUE, fixed=TRUE)) # Which are from the correct area
      k2 <- which(grepl(make.names(keeper2[[i]]$Indicator[j]), image_files, ignore.case=TRUE, fixed=TRUE)) # Which ones have the correct indicator name
      KEEP <- intersect(k1,k2)
      
      if (length(KEEP) > 1) {
        KEEP <- KEEP[which(!(grepl("Inside.Outside", image_files[KEEP], fixed=TRUE, ignore.case=TRUE)))]
        #KEEP <- KEEP[which(sub(".*_(.*?)\\.png$", "\\1", image_files[KEEP]) == keeper2[[i]]$Indicator[j])]
      }
      
      cat(sprintf(
  '<details>
     <summary style="
        cursor: pointer;
        font-weight: bold;
        font-size: 1.1em;
        padding: 4px 6px;
        border-radius: 4px;
        margin-bottom: 5px;">
        Indicator: %s <span style="background-color:%s; color:white; padding:2px 6px; border-radius:4px;">%s</span>
     </summary>\n\n',
  keeper2[[i]]$Indicator[j],
  ifelse(is.na(keeper2[[i]]$Grade[j]) | keeper2[[i]]$Grade[j] == "NA", "#EDEDED", unname(flowerPalette[calc_letter_grade(keeper2[[i]]$Grade[j])])),
  ifelse(is.na(keeper2[[i]]$Grade[j]) | keeper2[[i]]$Grade[j] == "NA", " ", round(keeper2[[i]]$Grade[j],0))
))
      
      plot_file <- image_files[KEEP]
      if (length(plot_file) > 0) {
      for (p in seq_along(plot_file)) {
            # Read the image
    img <- image_read(plot_file[p])
    
    # Get image info
    info <- image_info(img)
    
    # Crop 10% from top and bottom (keep 80% of height)
    crop_height <- info$height * 0.6
    img_cropped <- image_crop(
      img,
      geometry = geometry_area(
        width = info$width,
        height = crop_height,
        x = 0,
        y = info$height * 0.1  # start 10% down
      )
    )
    
    # Overwrite original file or create temp file
    tmp_file <- tempfile(fileext = ".png")
    image_write(img_cropped, path = tmp_file)
    
    # Embed cropped image
    cat(sprintf(
      '<img src="%s" style="width:600px; display:block; margin:0; padding:0;" />\n\n',
      tmp_file
    ))
    
      }
      } else {
        cat("There is no image available for this indicator as it was not sampled in this area.")
        cat("<br>")
      }
         if (is.na(keeper2[[i]]$Trend[j])) {
        trendy <- "No temporal analysis completed for this indicator."
      } else if (!(keeper2[[i]]$Trend[j] == "There is no temporal dimension in this data.")) {
      trendy <- keeper2[[i]]$Trend[j]
      } else {
        trendy <- keeper2[[i]]$Trend[j]
      }
      
      table_df <- data.frame(
        "Assumptions"=keeper2[[i]]$assumptions[j],
        "Caveats"= keeper2[[i]]$caveats[j],
        "Rationale"=keeper2[[i]]$Rationale[j],
                             "Status"=keeper2[[i]]$Status[j],
                             "Trend"= trendy,
                             "Score"= round(keeper2[[i]]$Grade[j],0),
                             "Scoring_Scheme"=keeper2[[i]]$Scheme[j],
                             "Source"=ifelse(is.na(keeper2[[i]]$Project[j]), keeper2[[i]]$Source[j], keeper2[[i]]$Title[j])
      )
      

      
      cat(knitr::kable(
  table_df,
  format = "html",
  table.attr = 'style="width:80%; margin-left:auto; margin-right:auto; border-collapse:collapse;"'
) %>%
  kableExtra::kable_styling(
    bootstrap_options = c("striped", "hover", "condensed"),
    full_width = FALSE,
    position = "center"
  ),
  "\n\n"
)
      ## Adding indicator so-what for ecological overview jaim
      weighted_grade_ind_eo <-  calc_letter_grade(
          weighted.mean(keeper2[[i]]$Grade[j], keeper2[[i]]$weight[j], na.rm = TRUE)
        )
if (!(weighted_grade_ind_eo == "NA")) {
          grade_text_eo <- grade_description('indicator')[[calc_letter_grade(keeper2[[i]]$Grade[j])]]
          
          
           years_ind_eo <- as.numeric(str_extract(unique(str_extract(keeper2[[i]]$quality[j], "\\(([^)]*)\\)")), "(?<=-)[0-9]+"))
      latest_year_ind_eo <- ifelse(length(years_ind_eo) > 0 && any(!is.na(years_ind_eo)),max(years_ind_eo, na.rm = TRUE),NA)
          
          
          } else {
            grade_text_eo <- 'more information is needed for this indicator'
          }

          sowhatind_eo <- paste0(
            keeper2[[i]]$Indicator[j], " has a score of ", calc_letter_grade(keeper2[[i]]$Grade[j]),
            " indicating ", tolower(grade_text_eo), ".",
            if (!is.na(latest_year_ind_eo)) {
              paste0(" The latest data we have that supports this objective is as of ", latest_year_ind_eo, ".")
            } else {
              " "
            })
          
          cat(sowhatind_eo)
          cat("<br>")

          if (!(state$mpas %in% regions$NAME_E)) {
            if (!(all(is.na(keeper2[[i]]$adjacent_score[j])))) {
              weighted_outside_grade_ind_eo <- calc_letter_grade(
          weighted.mean(keeper2[[i]]$adjacent_score[j], keeper2[[i]]$weight[j], na.rm = TRUE)
        )
              sowhatoutsideind_eo <- paste0(" For context, outside of the protected area has scored a ", weighted_outside_grade_ind_eo, ' indicating ', tolower(grade_description('indicator')[[weighted_outside_grade_ind_eo]]), ".")
            
               cat(sowhatoutsideind_eo)
          cat("<br>")
              
            }
          }
  cat("</details>\n\n") 

  } # END HERE INDICATOR
  } else {
  cat("There are no indicators in the app for this indicator bin.")
  }
  
  if (!(is.null(bin_na_indicators))) {
  cat("<br>")
  cat(paste0("The following indicators were identified as indicators that could inform this bin, however, no data has yet been obtained", paste0(bin_na_indicators, collapse=", ")))
  }
  cat("</details>\n\n")
}


```
</details> <details>
<summary style="
    font-size: 1.5em;       /* make the text bigger */
    font-weight: bold;       /* make it bold */
    cursor: pointer;         /* show pointer on hover */
">
THREATS
</summary>

```{r threats, echo=FALSE, results='asis'}
cat("<br>")


 # Preamble text
cat(
  "The Threats tab focuses specifically on indicators that measure pressures and threats to the ecosystem. ",
  "All relevant indicators for the area of interest are included, regardless of whether they contribute to a conservation objective. ",
  "Scores reflect the severity or status of each threat, providing a snapshot of potential risks to ecosystem health. ",
  "The accompanying table lists each indicator's bin, source, code, score, readiness, quality statement, and cost. ",
  "Readiness scores are explained as follows: "
)
cat("<br>")


cat(
  "<span><strong>Ready</strong> – Code is developed and data is integrated into the app;</span> ",
  "<span><strong>Readily Available</strong> – Data is being collected and stored but requires some work to integrate into the app;</span> ",
  "<span><strong>Not currently collected</strong> – Data is not yet being collected;</span> ",
  "<span><strong>Conceptual</strong> – There is no means of collecting this type of data;</span> ",
  "<span><strong>Unknown</strong> – More work needed to determine readiness score.</span>"
)
cat("<br>")

gradeLegendUI("threats")
                           
                           

cat(paste0("Table: Threat indicators in ", string, "\n"))

if (!(length(ddff_unique$PPTID) == 0)) {
  #browser()
  
  ddff_unique <- ddff_unique[which(grepl("Threats", ddff_unique$BIN)),]
  
  ddff_threats <- ddff_unique %>%
        arrange(GROUPING, SOURCE) %>%                # make sure sources are together within grouping
        group_by(GROUPING, SOURCE) %>%
        mutate(COST = ifelse(row_number() == 1, COST, "")) %>%  # only first row of each SOURCE shows COST
        ungroup()
  
  cat('<table border="1" style="border-collapse:collapse; width:100%;">\n')
cat('<thead><tr>',
    paste0('<th>', c("GROUPING", "BIN", "INDICATOR", "SOURCE", "SCORE", "READINESS", "QUALITY", "COST", "GRADE"), '</th>', collapse=""),
    '</tr></thead>\n')
cat('<tbody>\n')

for (i in seq_len(nrow(ddff_threats))) {
  
  # Compute grade
  grade <- calc_letter_grade(ddff_threats$SCORE[i])
  
  # Determine grade color (default white if NA)
  if (!is.na(grade) && grade != "NA") {
    grade_color <- flowerPalette[[grade]]
  } else {
    grade_color <- "#EDEDED"
  }
  
  # Start row (no row background color)
  cat('<tr>')
  
  # Regular cells (force white background to prevent accidental coloring)
  cat('<td style="background-color:white;">', ddff_threats$GROUPING[i], '</td>')
  cat('<td style="background-color:white;">', ddff_threats$BIN[i], '</td>')
  cat('<td style="background-color:white;">', ddff_threats$INDICATOR[i], '</td>')
  cat('<td style="background-color:white;">', ddff_threats$SOURCE[i], '</td>')
  cat('<td style="background-color:white;">', sprintf("%.2f", ddff_threats$SCORE[i]), '</td>')
  cat('<td style="background-color:white;">', ddff_threats$READINESS[i], '</td>')
  cat('<td style="background-color:white;">', ddff_threats$QUALITY[i], '</td>')
  cat('<td style="background-color:white;">', ddff_threats$COST[i], '</td>')
  
  # ✅ Grade column — last, colored cell, blank inside (or replace "" with grade letter)
  cat(sprintf('<td style="background-color:%s; font-weight:bold; text-align:center;">%s</td>',
              grade_color,
              ""))  # leave blank, or use grade to display the letter

  cat('</tr>\n')
}

cat('</tbody></table>')
}

```
</details>


## Investment Information

```{r disclaimer_site, echo=FALSE, results='asis', message=FALSE, warning=FALSE}
if (length(com$project_id) != 0) {
  cat("<p>Disclaimer: The cost information is based on the funding information in the project planning tool. 
      The amount is based on percentage of samples taken in the area of interest.</p>")
  
  
  om_in_site <- om[which(om$project_id %in% unique(com$project_id)),]

  for (i in seq_along(unique(com$project_id))) {
    p_id <- as.numeric(unique(com$project_id)[i])
    percentage <- com$percent_sites_in_mpa[which(com$project_id == p_id)]
    om_in_site$amount[which(om_in_site$project_id == p_id)] <- om_in_site$amount[which(om_in_site$project_id == p_id)] * (percentage/100)
  }
  
} else {
  cat("<p>There is no internal investment information available for this area.</p>")
}
```

```{r,results='asis', message=FALSE, error=FALSE, warning=FALSE, echo=FALSE}
if (length(com$project_id) != 0) {
dataSPA_plot <- dataSPA::plotSPA(om = om_in_site, which = "omBar")


# Save to a temporary HTML file
tmp_html <- tempfile(fileext = ".html")
saveWidget(dataSPA_plot, tmp_html, selfcontained = TRUE)

# Temporary PNG file path
tmp_png <- tempfile(fileext = ".png")

# Take a snapshot of the HTML widget
webshot(tmp_html, file = tmp_png, vwidth = 1000, vheight = 1000)

# Insert into the Rmd as a static image
#include_graphics(tmp_png)

} else {
  NULL
}
```

```{r cost_projects, echo=FALSE, results='asis', message=FALSE, warning=FALSE}
if (length(com$project_id) != 0) {
  cat(paste0("<p>The investment information is based on the following internal DFO projects that have had samples in ",
             params$mpas, " : ",
             paste0(paste(proj, " (", proj_titles, ")", sep = ""), collapse="; "),
             "</p>"))
}
```


```{r money_map, echo=FALSE, message=FALSE, warning=FALSE, error=FALSE}
apg <- all_project_geoms[-which(is.na(all_project_geoms$PPTID)),]
if (any(apg$areaID == "Non_Conservation_Area")) {
  apg <- apg[-which(apg$areaID == "Non_Conservation_Area"),]
}
# Create a new geometry list with rounded coords
rounded_geoms <- st_sfc(
  lapply(st_geometry(apg), function(pt) {
    coords <- st_coordinates(pt)
    coords_rounded <- round(coords, 2)
    coords_vec <- as.numeric(coords_rounded[1, ])
    st_point(coords_vec)
  }),
  crs = st_crs(apg)
)

# Then assign back to the sf object properly
st_geometry(apg) <- rounded_geoms

# Now find unique geometries
apg_unique <- apg %>% distinct(geometry, .keep_all = TRUE)

if(any(apg_unique$areaID == params$mpas)){
  # Getting lat and lng
coords_df <- do.call(rbind, lapply(st_geometry(apg_unique), function(pt) {
  c(lng = pt[1], lat = pt[2])
}))

# Add as columns to apg
apg_unique <- apg_unique %>%
  mutate(
    lng = coords_df["lng"],
    lat = coords_df["lat"]
  )

# Getting colors for polygons

money_mpas <- MPAs[which(MPAs$NAME_E %in% params$mpas),]

# GETTING PROJECTS
pptids <- unique(apg_unique$PPTID)

marker_color <- "lightblue"

# Assign FA icons for shapes
shape_icons <- c("anchor", "ship", "circle", "life-ring", "sailboat", "map-marker", "globe", "compass", "flag", "cloud", "water", "tint", "wave-square", "sun-o", "moon-o", "star", "bolt", "paper-plane", "location-arrow", "road", "truck", "ship-wheel", "life-ring", "circle", "square", "circle-o", "square-o", "dot-circle-o")


# Legend work
shape_map <- setNames(rep(shape_icons, length.out = length(pptids)), pptids)

# Set icons
apg_unique$map_icons <- NA
for (i in seq_along(pptids)) {
  apg_unique$map_icons[which(apg_unique$PPTID == as.numeric(pptids[i]))] <- shape_map[[which(names(shape_map) == pptids[i])]]
}

icons <- awesomeIcons(
  icon = apg_unique$map_icons,
  iconColor = "black",
  library = "fa",
  markerColor = marker_color
)

# Build legend items dynamically:
legend_items <- paste0(
  "<i class='fa fa-", shape_map[pptids], "' style='color: ", marker_color, ";'></i> ", pptids
)

# Combine into one HTML string
legend_html <- paste0(
  "<div style='background: white; padding: 8px; font-family: Arial;'>",
  "<b>Legend</b><br>",
  paste(legend_items, collapse = "<br>"),
  "</div>"
)


map <- leaflet(apg_unique[which(apg_unique$areaID == params$mpas),]) %>%
    addTiles() %>%
    addPolygons(
        data = money_mpas$geoms,
        fillColor = ifelse(money_mpas$NAME_E == params$mpas, fill_color, "lightgray"),
        fillOpacity = 0.9,
        color = "grey30",
        weight = 6,
        opacity = 1
    )%>%
  addAwesomeMarkers(
    ~lng, ~lat,
    icon = icons,
    popup = ~paste("Project ID:", PPTID)
  )%>%
  addControl(
    html = legend_html,
    position = "bottomright"
  )


# Saving the map as stagnant
tmp_html <- tempfile(fileext = ".html")
saveWidget(map, tmp_html, selfcontained = TRUE)

# Temporary PNG file path
tmp_png <- tempfile(fileext = ".png")

# Take a snapshot of the HTML widget
webshot(tmp_html, file = tmp_png, vwidth = 1000, vheight = 1000)



# ggplot pie chart
percent_funding <- percent_funding %>%
  mutate(
    fill_col = ifelse(MPA == params$mpas, fill_color, "gray"),
    legend_label = ifelse(MPA == params$mpas, MPA, "Other Protected Areas")  # ⬅ RED DOT: legend_label matches what we want in the legend
  )

# Named vector for scale_fill_manual
fill_values <- setNames(
  c(fill_color, "gray"),
  c(params$mpas, "Other Protected Areas")  # ⬅ RED DOT: name matches legend_label exactly
)

# Plot
gg_pie <- ggplot(percent_funding, aes(x = "", y = Funding_pct, fill = legend_label)) +
  geom_col(width = 1) +
  coord_polar(theta = "y") +
  scale_fill_manual(
    values = fill_values,
    name = "Protected Area"
  ) +
  labs(title = "Percentage of Funding by MPA") +
  theme_void()

#gg_pie
temp_file <- tempfile(fileext = ".png")
ggsave(temp_file, plot = gg_pie, width = 6, height = 4, dpi = 150)

tagList(
  tags$div(style = "display: flex; gap: 20px; align-items: center;",
           # Pie chart
           tags$div(style = "flex: 1;",
                    tags$img(
                      src = base64enc::dataURI(file = temp_file, mime = "image/png"),
                      style = "max-width: 100%; height: auto;"
                    )
           ),
           # Leaflet map snapshot
           tags$div(style = "flex: 1;",
                    tags$img(
                      src = base64enc::dataURI(file = tmp_png, mime = "image/png"),  # ⬅ RED CHANGE: insert PNG of map
                      style = "max-width: 100%; height: auto;"                      # ⬅ RED CHANGE: style for map image
                    )
           )
  )
)
} else {
  cat("There is no information on projects in this area.")
}





```


## Discussion

```{r, echo=FALSE, warning=FALSE, error=FALSE, results="asis", message=FALSE}

cat("### Status\n")

cat(paste0("In ", string, " there is an overall ecological status score of ", area_grade, ". This is based on a total of ", length(unique(ddff_display$INDICATOR)), " indicators. Of these ", length(unique(ddff_display$INDICATOR)), " indicators, ", length(which(ddff_display$SCORE>49)), " indicators are receiving a 'pass' score of 50 or greater. "))

if (area_grade %in% c("A", "B", "C")) {
  cat(paste0("The results suggest that the MPA is maintaining a healthy environmental condition."))
} else if (area_grade == "NA") {
  cat(paste0("Insufficient data are available to assess ecological condition, highlighting the need for monitoring to better understand and manage the MPA’s environmental health"))
} else {
  cat(paste0("This indicates that ecological conditions are below expectations, highlighting the need for targeted management actions to improce ecosystem health."))
}

if (length(unique(ddff_display$INDICATOR)) < 5) {
  cat(paste0("Though, it should be noted that additional work should be considered to add more indicators in this area."))
}

# Code for print statement
obj_ex <- read_excel(file.path(dirname(path_to_store()), "data", "objectives.xlsx"))

now_what <- NULL
for (i in seq_along(textO)) {
  msg <- paste0(textO[i], 
    " had a score of ", site_grades[i], 
    ", that is based on ", number_of_indicators[i], " indicators. "
  )
  
  # Conditional addition
  if (length(site_grades)<1){
    msg <- paste0(msg, " It is reccomended that further work be considered to support this objective.")
  } else if( site_grades[i] == "NA") {
    msg <- paste0(msg, " It is reccomended that further work be considered to support this objective.")
  } else if (site_grades[i] %in% c("A", "B", "C")) {
    msg <- paste0(msg, obj_ex$Success[which(obj_ex$Objective == textO[i])])
  } else {
    msg <- paste0(msg, obj_ex$Continue_Work[which(obj_ex$Objective == textO[i])])
    
  }
  
  if ( !is.null(number_of_indicators[i])){
    if (number_of_indicators[i] < 5) {
      msg <- paste0(msg, "Additional work should also be considered to add more indicators to support this objective.")
    }
  }
  msg <- paste0(msg, '\n\n')
  
  now_what[i] <- msg
}

cat("\n\n")
cat(paste0("From a management perspective,"))
cat("\n\n")
cat(now_what)
cat("\n\n")



cat("### Climate Change\n")
cat("<br>")

climate_indicators <- unique(pillar_ecol_df2$indicator[which(grepl("Inside", pillar_ecol_df2$indicator) & pillar_ecol_df2$areaID == params$mpas)])

for (i in seq_along(climate_indicators)) {
  indicator_keep <- which(pillar_ecol_df2$indicator == gsub(" Inside Outside Comparison$", "", climate_indicators[i]) & pillar_ecol_df2$areaID == params$mpas)
  
  if (!(length(indicator_keep) == 0) & !(is.na(pillar_ecol_df2$trend_statement[indicator_keep]))) {
    
    excel_keep <- which(climate_change$Indicator == climate_indicators[i])
    pillar_keep_inside <- which(pillar_ecol_df2$indicator == climate_indicators[i] & pillar_ecol_df2$areaID == params$mpas)
    
    cat(sprintf("<b>Indicator: %s.</b>\n\n",toupper(climate_indicators[i])))
    
    cat(climate_change$Context[excel_keep], "\n\n")
    cat("In our analysis, ")
    cat(pillar_ecol_df2$trend_statement[indicator_keep])
    
    if (!(grepl("There is only one year of data", pillar_ecol_df2$trend_statement[indicator_keep]))) {
    
    pval <- str_extract(pillar_ecol_df2$trend_statement[indicator_keep], "pval\\s*=\\s*\\d+(\\.\\d+)?") |>
      str_extract("\\d+(\\.\\d+)?") |>
      as.numeric()
    
    if (pval > 0.05) {
      cat(". The change in this indicator in the MPA is not significant.")
    } else {
      cat(". The change in this indicator in the MPA is significant.")
    }
    
    cat(" An inside/outside comparison was done to help understand the impacts of climate change on this variable. Results showed ")
    
    result <- pillar_ecol_df2$status_statement[pillar_keep_inside]
    
    cat(paste0(tolower(result), "."))
    
    if (!(grepl("Protection could therefore be positively impacting this variable", result))) {
      # No sig dif between the two
      desired <- sub(".*\\s+", "", pillar_ecol_df2$scoring[indicator_keep])
      actual_results <- ifelse(grepl("increase", sub("\\..*", ".", pillar_ecol_df2$trend_statement[indicator_keep])), "increase", "decrease")
      
      if (pval > 0.05) { ## This is pval of the variable (not inside/ outside)
        cat("The rate in which this indicator is changing is not significant (p=", pval,") which suggests that climate change does not seem to have a significant impact on that particular indicator.")
      } else {
        # change is significant
        if (identical(desired, actual_results)) {
          cat("The results show us that climate change doesn't seem to be impacting this indicator the way we would expect, and in fact, the trends are showing a statistically significant trend in the opposite direction than we would expect.")
        } else {
          #The trend is going in the opposite direction that we would expect and
          #statistically significant,we point out that according to our analysis
          cat("The results show us that climate change could be impacting this indicator the way we would expect, and in fact, the trends are showing a statistically significant
        trend in the direction than we would expect as a result of climate change.")
        }
      }
    }
    } else {
    cat("More sampling is suggested.")
  }
  }
  
  cat("\n\n")
}

cat("### Research Recommendations \n")
cat(paste0(
  "The following indicator bins do not have any data: ",
  paste0(summary_table$Indicator.Bin[which(summary_table$Grade == "NA")], collapse = ", "),
  ". It is recommended to further study these areas.\n"
))
cat("\n\n")

# Bad grade table
badGrade <- which(pillar_ecol_df2$areaID == params$mpas & (!(is.na(pillar_ecol_df2$indicator))) & (!(pillar_ecol_df2$indicator == "placeholder")) & (!(grepl('Inside Outside', pillar_ecol_df2$indicator))) & (pillar_ecol_df2$score < 51 | is.na(pillar_ecol_df2$score)))

badGradeTable <- pillar_ecol_df2[badGrade, ] |> 
  dplyr::group_by(bin) |>
  dplyr::ungroup() |>
  dplyr::select("indicator", "score")


cat("The following indicators are scoring low or don't have enough data to properly score. Some additional effort should be considered with these indicators: \n")


print(knitr::kable(badGradeTable, caption = "Indicator to Potentially Further Explore",row.names=FALSE))


```

## Outreach and engagement


### Collaborations and partnerships


```{r, echo=FALSE, warning=FALSE, error=FALSE, results="asis"}
project_subset <- pillar_ecol_df2$PPTID[which(pillar_ecol_df2$areaID == params$mpas)]
if (!(length(project_subset) == 0)) {
p_subset <- unique(trimws(unlist(strsplit(project_subset, ";")), "both"))
}
if (any(is.na(p_subset))) {
  p_subset <- p_subset[-which(is.na(p_subset))]
}
if (any(p_subset == "NA")) {
  p_subset <- p_subset[-which(p_subset == "NA")]
}

if (any(p_subset %in% collaborations$project_id)) {
  good_col <- which(collaborations$project_id %in% p_subset)
  collab_subset <- collaborations[good_col,]
  
  ## For collaborations, I need to obtain the year. This would allow me to say 'for this year, x collaborations happened, but in previous years for this project, Y collaborations have happened).
  
  year_keep <- which(collab_subset$fiscal_year == last_year)
  
  if (!(length(year_keep) == 0)) {
    recent_col <- collab_subset[year_keep, !(names(collab_subset) %in% c("project_year_id", "new_or_existing", "type", "critical"))]
    names(recent_col) <- c("Project ID", "Organization", "Year")

   organizations <- unique(recent_col$Organization)
    rc <- data.frame(Organization=organizations)
    
    for (i in seq_along(organizations)) {
      keeping <- which(recent_col$Organization == organizations[i])
      rc$Year[i] <- paste0(sort(unique(recent_col[keeping,]$Year)), collapse= ", ")
    }
    cat(paste0("The following collaborations/partnerships were identified for ", last_year, " for projects that contributed to this site:"))
    cat("<br>")

    print(knitr::kable(rc, caption = "Recent Collaborations and Partnerships",row.names=FALSE))
    cat("\n\n")
  } else {
  cat(paste0("In year ", last_year, " there were no identified collaborations/ partnerships. "))
  cat("<br>")

  }
  if (!(length(year_keep) == 0)) {
  if (!(length(which((!(1:length(collab_subset$project_id)%in% year_keep))))) == 0) {
    
    cat("The following past partnerships/collaborations have been identified and contributed to this site:")
    cat("<br>")

    past_coll <- collab_subset[-year_keep, !(names(collab_subset) %in% c("project_year_id", "new_or_existing", "type", "critical"))]
    names(past_coll) <- c("Project ID", "Organization", "Year")
    organizations <- unique(past_coll$Organization)
    pc <- data.frame(Organization=organizations)
    
    for (i in seq_along(organizations)) {
      keeping <- which(past_coll$Organization == organizations[i])
      pc$Year[i] <- paste0(sort(unique(past_coll[keeping,]$Year)), collapse= ", ")
    }

    print(knitr::kable(pc, caption = "Past Collaborations and Partnerships",row.names=FALSE))
    
  } else {
    cat("There are no partnerships/collaborations identified from previous years.")
    cat("<br>")

  }
  } else {
        cat("There are no partnerships/collaborations identified from previous years.")
        cat("<br>")


    
  }
} else {
    cat("There have been no identified collaborations/ partnerships for this area using the Project Planning Tool.")
    cat("<br>")

}
```


### Deliverables

```{r, echo=FALSE, error=FALSE, warning=FALSE, results='asis'}
deliv_keep <- which(deliverables$project_id %in% p_subset & deliverables$year == last_year) # Only projects for this area / last year

if (length(deliv_keep > 0)) {
  delv <- deliverables[deliv_keep,][c("classification_display", "description")]
  if (any(str_count(delv$description, "\\S+") > 35)) {
  delv$description[which(str_count(delv$description, "\\S+") > 35)] <- " "
  }
  
  names(delv) <- c("Deliverable", "Description")
  
  print(knitr::kable(delv, caption = paste0("Deliverables for " , last_year ),row.names=FALSE))
} else {
  cat("There has been no identified deliverables in the Project Planning Tool for projects supporting this area.")
}

```

### CSAS

```{r, echo=FALSE, error=FALSE, warning=FALSE, results='asis'}
# Which ones to keep
csas_keep <- which(grepl(paste(params$mpas, collapse = "|"), csas$title)) # params$mpas
if (params$mpas == "Western and Emerald Banks Marine Refuge") {
csas_keep <- c(csas_keep, which(grepl("Emerald Banks", csas$title, ignore.case=TRUE)))
} else if (params$mpas ==  "St. Anns Bank Marine Protected Area") {
  csas_keep <- c(csas_keep, which(grepl("Anns", csas$title, ignore.case=TRUE)))
} else if (params$mpas == "Musquash Estuary Marine Protected Area") {
  csas_keep <- c(csas_keep, which(grepl("Musquash", csas$title, ignore.case=TRUE)))
}

if (length(csas_keep) > 0) {
  CSAS <- csas[csas_keep,]
  names(CSAS) <- c("Title", "Date")
  print(knitr::kable(CSAS, caption = paste0("CSAS Processes for " , params$mpas),row.names=FALSE))
} else {
  cat("There have been no identified relevant CSAS meetings in the CSAS DMapps related to this area.")
}
```

